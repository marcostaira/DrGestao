generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id        String      @id @default(cuid())
  tenantId  String      @map("tenant_id")
  nome      String
  email     String
  senha     String
  tipo      TipoUsuario @default(SECRETARIA)
  ativo     Boolean     @default(true)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  tenant    Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([tenantId, email])
  @@map("usuarios")
}

model Profissional {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  nome          String
  especialidade String?
  cor           String   @default("#3B82F6") // Azul padrão
  observacoes   String?
  ativo         Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pacientes     Paciente[]
  agendamentos  Agendamento[]
  atendimentos  Atendimento[]

  @@index([tenantId, ativo])
  @@map("profissionais")
}

model Paciente {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  profissionalId String? @map("profissional_id")
  
  // Dados pessoais
  nome      String
  cpf       String?
  dataNascimento DateTime? @map("data_nascimento")
  
  // Contatos
  telefone  String
  telefone2 String?  @map("telefone2")
  email     String?
  
  // Endereço
  cep       String?
  logradouro String?
  numero    String?
  complemento String?
  bairro    String?
  cidade    String?
  estado    String?  @db.VarChar(2)
  
  // Dados médicos
  alergias  String?  @db.Text
  
  // Responsável (para menores de idade)
  menorIdade Boolean @default(false) @map("menor_idade")
  responsavelNome String? @map("responsavel_nome")
  responsavelCpf String? @map("responsavel_cpf")
  responsavelTelefone String? @map("responsavel_telefone")
  responsavelParentesco String? @map("responsavel_parentesco")
  
  observacoes String? @db.Text
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  profissional  Profissional? @relation(fields: [profissionalId], references: [id], onDelete: SetNull)
  agendamentos  Agendamento[]
  atendimentos  Atendimento[]

  @@map("pacientes")
  @@index([tenantId])
  @@index([tenantId, nome])
  @@index([tenantId, telefone])
  @@index([cpf])
}

model Procedimento {
  id             String        @id @default(cuid())
  tenantId       String        @map("tenant_id")
  nome           String
  valor          Decimal?      @db.Decimal(10, 2)
  duracaoMinutos Int           @map("duracao_minutos")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  agendamentos   Agendamento[]
  atendimentos   Atendimento[]
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, nome])
  @@map("procedimentos")
}

model Agendamento {
  id                 String            @id @default(cuid())
  tenantId           String            @map("tenant_id")
  pacienteId         String?           @map("paciente_id")
  profissionalId     String            @map("profissional_id")
  procedimentoId     String            @map("procedimento_id")
  dataHora           DateTime          @map("data_hora")
  status             StatusAgendamento @default(MARCADO)
  observacoes        String?
  confirmacaoEnviada Boolean           @default(false) @map("confirmacao_enviada")
  recorrenciaId       String?       @map("recorrencia_id") // NOVO CAMPO

  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  dataHoraFim        DateTime          @map("data_hora_fim")
  paciente           Paciente?         @relation(fields: [pacienteId], references: [id])
  procedimento       Procedimento      @relation(fields: [procedimentoId], references: [id], onDelete: Cascade)
  profissional       Profissional      @relation(fields: [profissionalId], references: [id], onDelete: Cascade)
  tenant             Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  atendimento        Atendimento?

  @@index([tenantId, dataHora])
  @@index([tenantId, profissionalId])
  @@index([tenantId, pacienteId])
  @@map("agendamentos")
}

model Atendimento {
  id                      String   @id @default(uuid())
  tenantId                String   @map("tenant_id")
  agendamentoId           String   @unique @map("agendamento_id")  // ADICIONAR @unique
  pacienteId              String   @map("paciente_id")
  profissionalId          String   @map("profissional_id")
  procedimentoId          String?  @map("procedimento_id")
  anotacoes               String?  @db.Text
  procedimentosRealizados Json     @default("[]") @map("procedimentos_realizados")
  cancelado               Boolean  @default(false)
  canceladoEm             DateTime? @map("cancelado_em")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agendamento  Agendamento   @relation(fields: [agendamentoId], references: [id], onDelete: Cascade)
  paciente     Paciente      @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  profissional Profissional  @relation(fields: [profissionalId], references: [id], onDelete: Cascade)
  procedimento Procedimento? @relation(fields: [procedimentoId], references: [id], onDelete: SetNull)

  @@map("atendimentos")
  @@index([tenantId, pacienteId])
  @@index([tenantId, profissionalId])
  @@index([tenantId, agendamentoId])
  @@index([tenantId, cancelado])
}

model WhatsAppConfig {
  id                      String   @id @default(cuid())
  tenantId                String   @unique @map("tenant_id")
  templateConfirmacao     String   @default("Olá {nome}! Você tem consulta marcada para {data} às {hora}. Para confirmar, responda: 1=SIM ou 2=NÃO") @map("template_confirmacao")
  templateSim             String   @default("Consulta confirmada! Nos vemos em {data} às {hora}.") @map("template_sim")
  templateNao             String   @default("Consulta cancelada. Entre em contato para reagendar.") @map("template_nao")
  templateOpcoesInvalidas String   @default("Resposta não reconhecida. Digite 1 para SIM ou 2 para NÃO.") @map("template_opcoes_invalidas")
  horasAntecedencia       Int      @default(24) @map("horas_antecedencia")
  ativo                   Boolean  @default(true)
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  tenant                  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("whatsapp_config")
}

model LogSistema {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  usuarioId String?  @map("usuario_id")
  tipo      TipoLog
  descricao String
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([tenantId, tipo])
  @@index([tenantId, createdAt])
  @@map("logs_sistema")
}

enum TipoUsuario {
  ADMIN
  SECRETARIA
}

enum StatusAgendamento {
  MARCADO
  CONFIRMADO
  COMPARECEU
  FALTOU
  CANCELADO
}

enum TipoLog {
  LOGIN
  LOGOUT
  AGENDAMENTO_CRIADO
  AGENDAMENTO_ATUALIZADO
  AGENDAMENTO_CANCELADO
  CONFIRMACAO_ENVIADA
  CONFIRMACAO_RECEBIDA
  SYNC_GOOGLE_CALENDAR
  ERROR
  CREATE
  UPDATE
  DELETE
}

model Plano {
  id        String   @id @default(cuid())
  nome      String   @unique
  slug      String   @unique
  descricao String?
  
  // Limites
  profissionaisAtivos Int  @map("profissionais_ativos")
  usuarios            Int
  agendamentosMes     Int  @map("agendamentos_mes")
  pacientes           Int
  armazenamentoMB     Int  @map("armazenamento_mb")
  
  // Funcionalidades
  whatsappAtivo       Boolean @default(false) @map("whatsapp_ativo")
  googleCalendarSync  Boolean @default(false) @map("google_calendar_sync")
  
  // Preço
  valorMensal         Decimal? @db.Decimal(10, 2) @map("valor_mensal")
  valorAnual          Decimal? @db.Decimal(10, 2) @map("valor_anual")
  
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  tenants   Tenant[]

  @@map("planos")
}

model Tenant {
  id             String          @id @default(cuid())
  nome           String
  planoId        String          @map("plano_id")
  ativo          Boolean         @default(true)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  
  plano          Plano           @relation(fields: [planoId], references: [id])
  agendamentos   Agendamento[]
  atendimentos   Atendimento[]
  pacientes      Paciente[]
  procedimentos  Procedimento[]
  profissionais  Profissional[]
  usuarios       Usuario[]
  whatsappConfig WhatsAppConfig?

  @@index([planoId])
  @@map("tenants")
}

